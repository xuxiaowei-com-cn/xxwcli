stages:
  - build
  - sync

build:1.21:
  stage: build
  image: golang:1.21
  script:
    - go version
    - go env -w GOPROXY=https://goproxy.cn,direct
    - go mod download
    - go test ./... -v
    - go build -ldflags "-X main.buildTime=$(date +%Y-%m-%d_%H:%M:%S%z) -X main.commitSha=$(git rev-parse HEAD) -X main.commitShortSha=$(git rev-parse --short HEAD) -X main.commitTimestamp=$(git log -1 --format="%cd" --date="format:%Y-%m-%d_%H:%M:%S%z")" xxwcli.go
    - ls
    - ./xxwcli -v
    - ./xxwcli v
  artifacts:
    name: "${CI_JOB_NAME}"
    paths:
      - xxwcli
  only:
    - main

#build:latest:macos:
#  stage: build
#  image: golang:latest
#  script:
#    - go version
#    - go env -w GOPROXY=https://goproxy.cn,direct
#    - go mod download
#    - go build xxwcli.go
#    - ls
#  artifacts:
#    name: "${CI_JOB_NAME}"
#    paths:
#      - xxwcli.out
#  tags:
#    - shared-macos-amd64
#  rules:
#    - if: $CI_COMMIT_BRANCH == "main" && $CI_SERVER_HOST != 'jihulab.com'

#build:1.19.5-windowsservercore:
#  stage: build
#  image: golang:1.19.5-windowsservercore
#  script:
#    - go version
#    - go env -w GOPROXY=https://goproxy.cn,direct
#    - go mod download
#    - go build xxwcli.go
#  artifacts:
#    name: "${CI_JOB_NAME}"
#    paths:
#      - xxwcli.exe
#  tags:
#    - windows
#  rules:
#    - if: $CI_COMMIT_BRANCH == "main" && $CI_SERVER_HOST != 'jihulab.com'

# 嵌入
include:
  # 同步代码
  - /sync.yml
